name: Build Native Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools: 34.0.0
        
    - name: Install Dependencies
      run: npm install
      
    - name: Verify Native Background GPS Files
      run: |
        echo "Checking native Android background GPS files..."
        ls -la android/app/src/main/java/com/miletrackerpro/app/
        echo "BackgroundLocationService.java:"
        head -10 android/app/src/main/java/com/miletrackerpro/app/BackgroundLocationService.java
        echo "MileTrackerGPSModule.java:"
        head -10 android/app/src/main/java/com/miletrackerpro/app/MileTrackerGPSModule.java
        echo "AndroidManifest.xml permissions:"
        grep -A5 -B5 "BACKGROUND_LOCATION" android/app/src/main/AndroidManifest.xml
        
    - name: Create Keystore
      run: |
        keytool -genkeypair -v -keystore android/app/miletracker-release-key.keystore \
          -alias miletracker-key-alias -keyalg RSA -keysize 2048 -validity 10000 \
          -dname "CN=MileTracker Pro, OU=Development, O=MileTracker, L=Unknown, S=Unknown, C=US" \
          -storepass android -keypass android
          
    - name: Create Gradle Properties
      run: |
        echo "MYAPP_RELEASE_STORE_FILE=miletracker-release-key.keystore" >> android/gradle.properties
        echo "MYAPP_RELEASE_KEY_ALIAS=miletracker-key-alias" >> android/gradle.properties
        echo "MYAPP_RELEASE_STORE_PASSWORD=android" >> android/gradle.properties
        echo "MYAPP_RELEASE_KEY_PASSWORD=android" >> android/gradle.properties
        
    - name: Make Gradlew Executable
      run: chmod +x android/gradlew
        
    - name: Build Android APK with Native Background GPS
      run: |
        cd android
        ./gradlew assembleRelease --no-daemon --stacktrace
        
    - name: Verify APK Creation
      run: |
        ls -la android/app/build/outputs/apk/release/
        echo "APK Size: $(du -h android/app/build/outputs/apk/release/app-release.apk | cut -f1)"
        
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: MileTracker-Pro-Native-Background-GPS
        path: android/app/build/outputs/apk/release/app-release.apk
        retention-days: 30
        
    - name: Create Release
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: native-background-gps-v${{ github.run_number }}
        name: MileTracker Pro - Native Background GPS v${{ github.run_number }}
        body: |
          ðŸš— **MileTracker Pro - Native Background GPS Tracking**
          
          **Key Features:**
          - âœ… True background GPS tracking (works when app is closed)
          - âœ… Native Android background service
          - âœ… Automatic trip detection and completion
          - âœ… Speed-based trip start/stop (8mph start, 3mph stop)
          - âœ… Professional foreground notification
          - âœ… Background location permissions
          - âœ… Wake lock for continuous tracking
          - âœ… Battery optimized location updates
          
          **Technical Implementation:**
          - Native Java background service (BackgroundLocationService.java)
          - Custom React Native bridge (MileTrackerGPSModule.java)
          - True foreground service with location permission
          - Comprehensive trip detection algorithm
          - Professional notification system
          
          **Installation:**
          1. Download the APK file below
          2. Transfer to your Android device
          3. Install APK (enable "Install from unknown sources" if needed)
          4. Grant location permissions when prompted
          5. Allow background location access for automatic tracking
          
          **Competing with MileIQ:**
          - Background tracking even when app is completely closed
          - No dependency on expensive commercial plugins
          - Professional-grade GPS filtering and trip detection
          - Native Android performance and battery optimization
          
          Built: ${{ github.event.head_commit.timestamp }}
          Commit: ${{ github.sha }}
        files: android/app/build/outputs/apk/release/app-release.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
