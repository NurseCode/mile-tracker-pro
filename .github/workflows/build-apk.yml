name: Phase 4 - True Background GPS Service

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Clean and create Android project structure
        run: |
          rm -rf android
          mkdir -p android/app/src/main/java/com/miletrackerpro/app
          mkdir -p android/app/src/main/res/layout
          mkdir -p android/app/src/main/res/values
          mkdir -p android/gradle/wrapper

      - name: Create Gradle wrapper
        run: |
          cat > android/gradle/wrapper/gradle-wrapper.properties << 'EOF'
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.6-all.zip
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          EOF

      - name: Create Gradle wrapper JAR
        run: |
          mkdir -p android/gradle/wrapper
          curl -L https://github.com/gradle/gradle/raw/v8.6.0/gradle/wrapper/gradle-wrapper.jar -o android/gradle/wrapper/gradle-wrapper.jar

      - name: Create gradlew script
        run: |
          cat > android/gradlew << 'EOF'
          #!/usr/bin/env sh
          APP_HOME="`dirname \"$0\"`"
          CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar
          if [ -n "$JAVA_HOME" ] ; then
              JAVACMD="$JAVA_HOME/bin/java"
          else
              JAVACMD="java"
          fi
          exec "$JAVACMD" -classpath "$CLASSPATH" org.gradle.wrapper.GradleWrapperMain "$@"
          EOF
          chmod +x android/gradlew

      - name: Create settings.gradle
        run: |
          cat > android/settings.gradle << 'EOF'
          rootProject.name = 'MileTrackerPro'
          include ':app'
          EOF

      - name: Create build.gradle
        run: |
          cat > android/build.gradle << 'EOF'
          buildscript {
              ext {
                  buildToolsVersion = "34.0.0"
                  minSdkVersion = 21
                  compileSdkVersion = 34
                  targetSdkVersion = 34
              }
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath("com.android.tools.build:gradle:8.2.1")
              }
          }
          
          allprojects {
              repositories {
                  google()
                  mavenCentral()
              }
          }
          EOF

      - name: Create app/build.gradle
        run: |
          cat > android/app/build.gradle << 'EOF'
          apply plugin: "com.android.application"
          
          android {
              namespace "com.miletrackerpro.app"
              compileSdkVersion 34
              
              defaultConfig {
                  applicationId "com.miletrackerpro.app"
                  minSdkVersion 21
                  targetSdkVersion 34
                  versionCode 6
                  versionName "6.0"
              }
              
              buildTypes {
                  release {
                      minifyEnabled false
                  }
              }
              
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_1_8
                  targetCompatibility JavaVersion.VERSION_1_8
              }
          }
          
          dependencies {
              // Pure Android - no external dependencies
          }
          EOF

      - name: Create strings.xml
        run: |
          cat > android/app/src/main/res/values/strings.xml << 'EOF'
          <resources>
              <string name="app_name">MileTracker Pro</string>
              <string name="background_gps_title">Background GPS Active</string>
              <string name="background_gps_text">MileTracker is monitoring your trips</string>
              <string name="trip_active_title">Trip in Progress</string>
              <string name="trip_active_text">Currently tracking your drive</string>
          </resources>
          EOF

      - name: Create Background GPS Service
        run: |
          cat > android/app/src/main/java/com/miletrackerpro/app/BackgroundGPSService.java << 'EOF'
          package com.miletrackerpro.app;
          
          import android.app.Service;
          import android.content.Intent;
          import android.os.IBinder;
          import android.app.NotificationManager;
          import android.app.NotificationChannel;
          import android.app.Notification;
          import android.app.PendingIntent;
          import android.os.Build;
          import android.content.Context;
          import android.location.LocationManager;
          import android.location.LocationListener;
          import android.location.Location;
          import android.os.Bundle;
          import android.content.SharedPreferences;
          import android.os.PowerManager;
          import android.os.Handler;
          import android.os.Looper;
          import java.util.ArrayList;
          import java.util.List;
          import java.util.Locale;
          import org.json.JSONObject;
          import org.json.JSONArray;
          import org.json.JSONException;
          
          public class BackgroundGPSService extends Service implements LocationListener {
              
              private static final int NOTIFICATION_ID = 1001;
              private static final String CHANNEL_ID = "MileTrackerGPS";
              
              private LocationManager locationManager;
              private SharedPreferences preferences;
              private PowerManager.WakeLock wakeLock;
              private Handler handler = new Handler(Looper.getMainLooper());
              
              // Trip state
              private boolean isActiveTrip = false;
              private Location startLocation;
              private Location lastLocation;
              private long tripStartTime;
              private float totalDistance = 0;
              
              // Speed detection
              private List<Float> recentSpeeds = new ArrayList<>();
              private long lastLocationTime = 0;
              private int stationaryCount = 0;
              private int movingCount = 0;
              
              @Override
              public void onCreate() {
                  super.onCreate();
                  
                  locationManager = (LocationManager) getSystemService(Context.LOCATION_SERVICE);
                  preferences = getSharedPreferences("MileTracker", Context.MODE_PRIVATE);
                  
                  // Keep CPU awake for GPS tracking
                  PowerManager powerManager = (PowerManager) getSystemService(Context.POWER_SERVICE);
                  wakeLock = powerManager.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK, "MileTracker:GPS");
                  wakeLock.acquire();
                  
                  createNotificationChannel();
                  startLocationTracking();
                  startForeground(NOTIFICATION_ID, createNotification("Background GPS Active", "Monitoring for trips"));
              }
              
              @Override
              public int onStartCommand(Intent intent, int flags, int startId) {
                  return START_STICKY; // Restart service if killed
              }
              
              @Override
              public IBinder onBind(Intent intent) {
                  return null;
              }
              
              @Override
              public void onDestroy() {
                  super.onDestroy();
                  
                  if (locationManager != null) {
                      locationManager.removeUpdates(this);
                  }
                  
                  if (wakeLock != null && wakeLock.isHeld()) {
                      wakeLock.release();
                  }
                  
                  // Save any active trip before stopping
                  if (isActiveTrip) {
                      saveTrip(totalDistance, System.currentTimeMillis() - tripStartTime);
                  }
              }
              
              private void createNotificationChannel() {
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                      NotificationChannel channel = new NotificationChannel(
                          CHANNEL_ID,
                          "Background GPS Tracking",
                          NotificationManager.IMPORTANCE_LOW
                      );
                      channel.setDescription("Tracks your trips in the background");
                      channel.setShowBadge(false);
                      
                      NotificationManager notificationManager = getSystemService(NotificationManager.class);
                      notificationManager.createNotificationChannel(channel);
                  }
              }
              
              private Notification createNotification(String title, String text) {
                  Intent notificationIntent = new Intent(this, MainActivity.class);
                  PendingIntent pendingIntent = PendingIntent.getActivity(
                      this, 0, notificationIntent, PendingIntent.FLAG_IMMUTABLE);
                  
                  Notification.Builder builder;
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                      builder = new Notification.Builder(this, CHANNEL_ID);
                  } else {
                      builder = new Notification.Builder(this);
                  }
                  
                  return builder
                      .setContentTitle(title)
                      .setContentText(text)
                      .setSmallIcon(android.R.drawable.ic_menu_mylocation)
                      .setContentIntent(pendingIntent)
                      .setOngoing(true)
                      .build();
              }
              
              private void updateNotification(String title, String text) {
                  NotificationManager notificationManager = (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);
                  notificationManager.notify(NOTIFICATION_ID, createNotification(title, text));
              }
              
              private void startLocationTracking() {
                  try {
                      // Request location updates every 5 seconds, minimum 10 meters
                      locationManager.requestLocationUpdates(LocationManager.GPS_PROVIDER, 5000, 10, this);
                      locationManager.requestLocationUpdates(LocationManager.NETWORK_PROVIDER, 5000, 10, this);
                  } catch (SecurityException e) {
                      // Permission not granted
                  }
              }
              
              @Override
              public void onLocationChanged(Location location) {
                  // Calculate speed
                  float speed = 0;
                  if (lastLocation != null && location.hasSpeed()) {
                      speed = location.getSpeed() * 2.237f; // Convert m/s to mph
                  } else if (lastLocation != null && lastLocationTime > 0) {
                      long timeDiff = System.currentTimeMillis() - lastLocationTime;
                      if (timeDiff > 0) {
                          float distance = lastLocation.distanceTo(location);
                          speed = (distance / (timeDiff / 1000.0f)) * 2.237f;
                      }
                  }
                  
                  // Process auto-detection
                  processAutoDetection(speed, location);
                  
                  // Update trip distance if active
                  if (isActiveTrip && lastLocation != null) {
                      float distance = lastLocation.distanceTo(location);
                      if (distance > 15) { // Only count significant movement
                          totalDistance += distance * 0.000621371f; // Convert meters to miles
                      }
                  }
                  
                  lastLocation = location;
                  lastLocationTime = System.currentTimeMillis();
                  
                  // Broadcast location update to app if running
                  Intent intent = new Intent("com.miletrackerpro.LOCATION_UPDATE");
                  intent.putExtra("speed", speed);
                  intent.putExtra("distance", totalDistance);
                  intent.putExtra("isActiveTrip", isActiveTrip);
                  sendBroadcast(intent);
              }
              
              private void processAutoDetection(float speed, Location location) {
                  // Add speed to recent readings
                  recentSpeeds.add(speed);
                  if (recentSpeeds.size() > 5) {
                      recentSpeeds.remove(0);
                  }
                  
                  // Check if moving consistently (>8 mph for 3+ readings)
                  if (speed > 8.0f) {
                      movingCount++;
                      stationaryCount = 0;
                      
                      if (movingCount >= 3 && !isActiveTrip) {
                          startTrip(location);
                      }
                  } else {
                      stationaryCount++;
                      movingCount = 0;
                      
                      // Stop trip if stationary for 4+ readings (20+ seconds)
                      if (stationaryCount >= 4 && isActiveTrip) {
                          stopTrip();
                      }
                  }
              }
              
              private void startTrip(Location location) {
                  isActiveTrip = true;
                  tripStartTime = System.currentTimeMillis();
                  totalDistance = 0;
                  startLocation = location;
                  lastLocation = location;
                  
                  updateNotification("Trip in Progress", String.format(Locale.US, "%.1f miles", totalDistance));
                  
                  // Broadcast trip start to app
                  Intent intent = new Intent("com.miletrackerpro.TRIP_START");
                  sendBroadcast(intent);
              }
              
              private void stopTrip() {
                  if (!isActiveTrip) return;
                  
                  long tripDuration = System.currentTimeMillis() - tripStartTime;
                  
                  // Only save trips with meaningful distance and duration
                  if (totalDistance > 0.1f && tripDuration > 30000) { // >0.1 miles and >30 seconds
                      saveTrip(totalDistance, tripDuration);
                      
                      updateNotification("Trip Completed", 
                          String.format(Locale.US, "%.1f miles in %s", totalDistance, formatDuration(tripDuration)));
                      
                      // Show completion notification briefly, then return to monitoring
                      handler.postDelayed(() -> {
                          updateNotification("Background GPS Active", "Monitoring for trips");
                      }, 5000);
                  } else {
                      updateNotification("Background GPS Active", "Monitoring for trips");
                  }
                  
                  isActiveTrip = false;
                  
                  // Broadcast trip end to app
                  Intent intent = new Intent("com.miletrackerpro.TRIP_END");
                  intent.putExtra("distance", totalDistance);
                  intent.putExtra("duration", tripDuration);
                  sendBroadcast(intent);
                  
                  // Reset for next trip
                  totalDistance = 0;
                  startLocation = null;
              }
              
              private void saveTrip(float distance, long duration) {
                  try {
                      String tripsJson = preferences.getString("trips", "[]");
                      JSONArray trips = new JSONArray(tripsJson);
                      
                      JSONObject newTrip = new JSONObject();
                      newTrip.put("date", System.currentTimeMillis());
                      newTrip.put("distance", distance);
                      newTrip.put("duration", duration);
                      newTrip.put("method", "Auto Background");
                      
                      trips.put(newTrip);
                      preferences.edit().putString("trips", trips.toString()).apply();
                      
                  } catch (JSONException e) {
                      // Error saving trip
                  }
              }
              
              private String formatDuration(long milliseconds) {
                  long seconds = milliseconds / 1000;
                  long minutes = seconds / 60;
                  long hours = minutes / 60;
                  
                  if (hours > 0) {
                      return String.format(Locale.US, "%d:%02d:%02d", hours, minutes % 60, seconds % 60);
                  } else {
                      return String.format(Locale.US, "%02d:%02d", minutes, seconds % 60);
                  }
              }
              
              @Override
              public void onStatusChanged(String provider, int status, Bundle extras) {}
              
              @Override
              public void onProviderEnabled(String provider) {}
              
              @Override
              public void onProviderDisabled(String provider) {}
          }
          EOF

      - name: Create Enhanced MainActivity with background service
        run: |
          cat > android/app/src/main/java/com/miletrackerpro/app/MainActivity.java << 'EOF'
          package com.miletrackerpro.app;
          
          import android.app.Activity;
          import android.os.Bundle;
          import android.widget.LinearLayout;
          import android.widget.TextView;
          import android.widget.Button;
          import android.widget.ScrollView;
          import android.widget.Switch;
          import android.graphics.Color;
          import android.view.Gravity;
          import android.view.ViewGroup;
          import android.widget.Toast;
          import android.content.Context;
          import android.content.Intent;
          import android.content.BroadcastReceiver;
          import android.content.IntentFilter;
          import android.Manifest;
          import android.content.pm.PackageManager;
          import android.os.Build;
          import android.content.SharedPreferences;
          import android.os.Handler;
          import java.text.SimpleDateFormat;
          import java.util.Date;
          import java.util.Locale;
          import org.json.JSONObject;
          import org.json.JSONArray;
          import org.json.JSONException;
          
          public class MainActivity extends Activity {
              
              private SharedPreferences preferences;
              private Handler handler = new Handler();
              private BroadcastReceiver locationReceiver;
              
              // State
              private boolean isBackgroundServiceRunning = false;
              private boolean isActiveTrip = false;
              private long tripStartTime = 0;
              private float currentDistance = 0;
              private float currentSpeed = 0;
              private int currentView = 0; // 0 = tracking, 1 = trips
              
              // UI elements
              private TextView statusText;
              private TextView speedText;
              private TextView distanceText;
              private TextView timeText;
              private Button serviceButton;
              private Button viewTripsButton;
              private LinearLayout mainLayout;
              private ScrollView tripsScrollView;
              private LinearLayout tripsLayout;
              
              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  
                  preferences = getSharedPreferences("MileTracker", Context.MODE_PRIVATE);
                  
                  createUserInterface();
                  setupBroadcastReceiver();
                  checkLocationPermission();
              }
              
              @Override
              protected void onResume() {
                  super.onResume();
                  updateServiceStatus();
                  if (isActiveTrip) {
                      updateTimer();
                  }
              }
              
              @Override
              protected void onDestroy() {
                  super.onDestroy();
                  if (locationReceiver != null) {
                      unregisterReceiver(locationReceiver);
                  }
              }
              
              private void setupBroadcastReceiver() {
                  locationReceiver = new BroadcastReceiver() {
                      @Override
                      public void onReceive(Context context, Intent intent) {
                          String action = intent.getAction();
                          
                          if ("com.miletrackerpro.LOCATION_UPDATE".equals(action)) {
                              currentSpeed = intent.getFloatExtra("speed", 0);
                              currentDistance = intent.getFloatExtra("distance", 0);
                              boolean tripActive = intent.getBooleanExtra("isActiveTrip", false);
                              
                              speedText.setText(String.format(Locale.US, "Speed: %.1f mph", currentSpeed));
                              
                              if (tripActive) {
                                  distanceText.setText(String.format(Locale.US, "Distance: %.2f miles", currentDistance));
                              }
                              
                          } else if ("com.miletrackerpro.TRIP_START".equals(action)) {
                              isActiveTrip = true;
                              tripStartTime = System.currentTimeMillis();
                              statusText.setText("Background Trip Active");
                              updateTimer();
                              
                          } else if ("com.miletrackerpro.TRIP_END".equals(action)) {
                              isActiveTrip = false;
                              statusText.setText("Background GPS Active");
                              float distance = intent.getFloatExtra("distance", 0);
                              long duration = intent.getLongExtra("duration", 0);
                              
                              Toast.makeText(MainActivity.this, 
                                  String.format(Locale.US, "Background trip completed: %.1f miles", distance), 
                                  Toast.LENGTH_LONG).show();
                              
                              // Reset display
                              distanceText.setText("Distance: 0.0 miles");
                              timeText.setText("Duration: 00:00");
                          }
                      }
                  };
                  
                  IntentFilter filter = new IntentFilter();
                  filter.addAction("com.miletrackerpro.LOCATION_UPDATE");
                  filter.addAction("com.miletrackerpro.TRIP_START");
                  filter.addAction("com.miletrackerpro.TRIP_END");
                  registerReceiver(locationReceiver, filter);
              }
              
              private void createUserInterface() {
                  // Main container
                  mainLayout = new LinearLayout(this);
                  mainLayout.setOrientation(LinearLayout.VERTICAL);
                  mainLayout.setBackgroundColor(Color.parseColor("#667eea"));
                  mainLayout.setPadding(40, 60, 40, 40);
                  
                  // Title
                  TextView title = new TextView(this);
                  title.setText("MileTracker Pro");
                  title.setTextSize(32);
                  title.setTextColor(Color.WHITE);
                  title.setGravity(Gravity.CENTER);
                  title.setPadding(0, 0, 0, 30);
                  mainLayout.addView(title);
                  
                  createTrackingInterface();
                  createTripsInterface();
                  
                  setContentView(mainLayout);
                  showTrackingView();
              }
              
              private void createTrackingInterface() {
                  // Status card
                  LinearLayout statusCard = new LinearLayout(this);
                  statusCard.setOrientation(LinearLayout.VERTICAL);
                  statusCard.setBackgroundColor(Color.parseColor("#ffffff"));
                  statusCard.setPadding(30, 30, 30, 30);
                  statusCard.setLayoutParams(new LinearLayout.LayoutParams(
                      ViewGroup.LayoutParams.MATCH_PARENT, 
                      ViewGroup.LayoutParams.WRAP_CONTENT));
                  
                  // Status text
                  statusText = new TextView(this);
                  statusText.setText("Ready for Background GPS");
                  statusText.setTextSize(20);
                  statusText.setTextColor(Color.parseColor("#333333"));
                  statusText.setGravity(Gravity.CENTER);
                  statusText.setPadding(0, 0, 0, 15);
                  statusCard.addView(statusText);
                  
                  // Speed display
                  speedText = new TextView(this);
                  speedText.setText("Speed: 0.0 mph");
                  speedText.setTextSize(16);
                  speedText.setTextColor(Color.parseColor("#666666"));
                  speedText.setGravity(Gravity.CENTER);
                  speedText.setPadding(0, 0, 0, 10);
                  statusCard.addView(speedText);
                  
                  // Distance display
                  distanceText = new TextView(this);
                  distanceText.setText("Distance: 0.0 miles");
                  distanceText.setTextSize(18);
                  distanceText.setTextColor(Color.parseColor("#666666"));
                  distanceText.setGravity(Gravity.CENTER);
                  statusCard.addView(distanceText);
                  
                  // Time display
                  timeText = new TextView(this);
                  timeText.setText("Duration: 00:00");
                  timeText.setTextSize(18);
                  timeText.setTextColor(Color.parseColor("#666666"));
                  timeText.setGravity(Gravity.CENTER);
                  timeText.setPadding(0, 10, 0, 0);
                  statusCard.addView(timeText);
                  
                  mainLayout.addView(statusCard);
                  
                  // Service control button
                  serviceButton = new Button(this);
                  serviceButton.setText("START BACKGROUND GPS");
                  serviceButton.setTextSize(18);
                  serviceButton.setTextColor(Color.WHITE);
                  serviceButton.setBackgroundColor(Color.parseColor("#10b981"));
                  serviceButton.setPadding(40, 30, 40, 30);
                  LinearLayout.LayoutParams buttonParams = new LinearLayout.LayoutParams(
                      ViewGroup.LayoutParams.MATCH_PARENT, 
                      ViewGroup.LayoutParams.WRAP_CONTENT);
                  buttonParams.setMargins(0, 40, 0, 20);
                  serviceButton.setLayoutParams(buttonParams);
                  
                  serviceButton.setOnClickListener(v -> {
                      if (isBackgroundServiceRunning) {
                          stopBackgroundService();
                      } else {
                          startBackgroundService();
                      }
                  });
                  
                  mainLayout.addView(serviceButton);
                  
                  // View trips button
                  viewTripsButton = new Button(this);
                  viewTripsButton.setText("VIEW TRIPS");
                  viewTripsButton.setTextSize(16);
                  viewTripsButton.setTextColor(Color.parseColor("#667eea"));
                  viewTripsButton.setBackgroundColor(Color.WHITE);
                  viewTripsButton.setPadding(40, 20, 40, 20);
                  LinearLayout.LayoutParams viewButtonParams = new LinearLayout.LayoutParams(
                      ViewGroup.LayoutParams.MATCH_PARENT, 
                      ViewGroup.LayoutParams.WRAP_CONTENT);
                  viewButtonParams.setMargins(0, 0, 0, 20);
                  viewTripsButton.setLayoutParams(viewButtonParams);
                  
                  viewTripsButton.setOnClickListener(v -> showTripsView());
                  mainLayout.addView(viewTripsButton);
                  
                  // Feature description
                  TextView features = new TextView(this);
                  features.setText("✓ True background GPS tracking\n✓ Works with phone closed\n✓ Automatic trip detection\n✓ Battery optimized");
                  features.setTextSize(14);
                  features.setTextColor(Color.parseColor("#c7d2fe"));
                  features.setGravity(Gravity.CENTER);
                  features.setLineSpacing(4, 1.2f);
                  features.setPadding(0, 20, 0, 0);
                  mainLayout.addView(features);
              }
              
              private void createTripsInterface() {
                  // Trips scroll view
                  tripsScrollView = new ScrollView(this);
                  tripsScrollView.setBackgroundColor(Color.WHITE);
                  tripsScrollView.setLayoutParams(new LinearLayout.LayoutParams(
                      ViewGroup.LayoutParams.MATCH_PARENT, 
                      ViewGroup.LayoutParams.WRAP_CONTENT));
                  tripsScrollView.setPadding(20, 20, 20, 20);
                  
                  tripsLayout = new LinearLayout(this);
                  tripsLayout.setOrientation(LinearLayout.VERTICAL);
                  tripsScrollView.addView(tripsLayout);
                  
                  // Back button
                  Button backButton = new Button(this);
                  backButton.setText("← BACK TO TRACKING");
                  backButton.setTextSize(16);
                  backButton.setTextColor(Color.WHITE);
                  backButton.setBackgroundColor(Color.parseColor("#667eea"));
                  backButton.setPadding(40, 20, 40, 20);
                  LinearLayout.LayoutParams backButtonParams = new LinearLayout.LayoutParams(
                      ViewGroup.LayoutParams.MATCH_PARENT, 
                      ViewGroup.LayoutParams.WRAP_CONTENT);
                  backButtonParams.setMargins(0, 20, 0, 0);
                  backButton.setLayoutParams(backButtonParams);
                  
                  backButton.setOnClickListener(v -> showTrackingView());
                  mainLayout.addView(backButton);
                  mainLayout.addView(tripsScrollView);
              }
              
              private void showTrackingView() {
                  currentView = 0;
                  tripsScrollView.setVisibility(LinearLayout.GONE);
              }
              
              private void showTripsView() {
                  currentView = 1;
                  tripsScrollView.setVisibility(LinearLayout.VISIBLE);
                  loadTripsHistory();
              }
              
              private void startBackgroundService() {
                  Intent serviceIntent = new Intent(this, BackgroundGPSService.class);
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                      startForegroundService(serviceIntent);
                  } else {
                      startService(serviceIntent);
                  }
                  
                  isBackgroundServiceRunning = true;
                  updateServiceStatus();
                  
                  Toast.makeText(this, "Background GPS service started", Toast.LENGTH_SHORT).show();
              }
              
              private void stopBackgroundService() {
                  Intent serviceIntent = new Intent(this, BackgroundGPSService.class);
                  stopService(serviceIntent);
                  
                  isBackgroundServiceRunning = false;
                  isActiveTrip = false;
                  updateServiceStatus();
                  
                  Toast.makeText(this, "Background GPS service stopped", Toast.LENGTH_SHORT).show();
              }
              
              private void updateServiceStatus() {
                  if (isBackgroundServiceRunning) {
                      serviceButton.setText("STOP BACKGROUND GPS");
                      serviceButton.setBackgroundColor(Color.parseColor("#ef4444"));
                      statusText.setText(isActiveTrip ? "Background Trip Active" : "Background GPS Active");
                  } else {
                      serviceButton.setText("START BACKGROUND GPS");
                      serviceButton.setBackgroundColor(Color.parseColor("#10b981"));
                      statusText.setText("Ready for Background GPS");
                      speedText.setText("Speed: 0.0 mph");
                      distanceText.setText("Distance: 0.0 miles");
                      timeText.setText("Duration: 00:00");
                  }
              }
              
              private void updateTimer() {
                  if (isActiveTrip && tripStartTime > 0) {
                      long duration = System.currentTimeMillis() - tripStartTime;
                      timeText.setText("Duration: " + formatDuration(duration));
                      
                      // Update every second
                      handler.postDelayed(this::updateTimer, 1000);
                  }
              }
              
              private void checkLocationPermission() {
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
                      String[] permissions = {
                          Manifest.permission.ACCESS_FINE_LOCATION,
                          Manifest.permission.ACCESS_COARSE_LOCATION
                      };
                      
                      boolean needsPermission = false;
                      for (String permission : permissions) {
                          if (checkSelfPermission(permission) != PackageManager.PERMISSION_GRANTED) {
                              needsPermission = true;
                              break;
                          }
                      }
                      
                      if (needsPermission) {
                          requestPermissions(permissions, 1);
                      }
                  }
              }
              
              @Override
              public void onRequestPermissionsResult(int requestCode, String[] permissions, int[] grantResults) {
                  if (requestCode == 1) {
                      boolean allGranted = true;
                      for (int result : grantResults) {
                          if (result != PackageManager.PERMISSION_GRANTED) {
                              allGranted = false;
                              break;
                          }
                      }
                      
                      if (!allGranted) {
                          Toast.makeText(this, "Location permissions required for background GPS tracking", Toast.LENGTH_LONG).show();
                      }
                  }
              }
              
              private void loadTripsHistory() {
                  tripsLayout.removeAllViews();
                  
                  String tripsJson = preferences.getString("trips", "[]");
                  try {
                      JSONArray trips = new JSONArray(tripsJson);
                      
                      if (trips.length() == 0) {
                          TextView noTrips = new TextView(this);
                          noTrips.setText("No trips recorded yet.\nStart background GPS and drive to automatically track trips!");
                          noTrips.setTextSize(16);
                          noTrips.setTextColor(Color.parseColor("#666666"));
                          noTrips.setGravity(Gravity.CENTER);
                          noTrips.setPadding(20, 40, 20, 40);
                          tripsLayout.addView(noTrips);
                          return;
                      }
                      
                      TextView header = new TextView(this);
                      header.setText("Trip History (" + trips.length() + " trips)");
                      header.setTextSize(20);
                      header.setTextColor(Color.parseColor("#333333"));
                      header.setGravity(Gravity.CENTER);
                      header.setPadding(0, 0, 0, 20);
                      tripsLayout.addView(header);
                      
                      float totalMiles = 0;
                      long totalDuration = 0;
                      
                      for (int i = trips.length() - 1; i >= 0; i--) {
                          JSONObject trip = trips.getJSONObject(i);
                          
                          LinearLayout tripCard = new LinearLayout(this);
                          tripCard.setOrientation(LinearLayout.VERTICAL);
                          tripCard.setBackgroundColor(Color.parseColor("#f8f9fa"));
                          tripCard.setPadding(20, 15, 20, 15);
                          LinearLayout.LayoutParams cardParams = new LinearLayout.LayoutParams(
                              ViewGroup.LayoutParams.MATCH_PARENT, 
                              ViewGroup.LayoutParams.WRAP_CONTENT);
                          cardParams.setMargins(0, 0, 0, 10);
                          tripCard.setLayoutParams(cardParams);
                          
                          TextView tripInfo = new TextView(this);
                          String dateStr = new SimpleDateFormat("MMM dd 'at' h:mm a", Locale.US)
                              .format(new Date(trip.getLong("date")));
                          float miles = (float) trip.getDouble("distance");
                          String duration = formatDuration(trip.getLong("duration"));
                          String method = trip.optString("method", "Auto Background");
                          
                          tripInfo.setText(String.format(Locale.US, 
                              "%s (%s)\n%.2f miles • %s", dateStr, method, miles, duration));
                          tripInfo.setTextSize(14);
                          tripInfo.setTextColor(Color.parseColor("#333333"));
                          tripCard.addView(tripInfo);
                          
                          tripsLayout.addView(tripCard);
                          
                          totalMiles += miles;
                          totalDuration += trip.getLong("duration");
                      }
                      
                      // Summary card
                      LinearLayout summaryCard = new LinearLayout(this);
                      summaryCard.setOrientation(LinearLayout.VERTICAL);
                      summaryCard.setBackgroundColor(Color.parseColor("#667eea"));
                      summaryCard.setPadding(20, 20, 20, 20);
                      LinearLayout.LayoutParams summaryParams = new LinearLayout.LayoutParams(
                          ViewGroup.LayoutParams.MATCH_PARENT, 
                          ViewGroup.LayoutParams.WRAP_CONTENT);
                      summaryParams.setMargins(0, 20, 0, 0);
                      summaryCard.setLayoutParams(summaryParams);
                      
                      TextView summaryText = new TextView(this);
                      float deduction = totalMiles * 0.70f; // IRS business rate
                      summaryText.setText(String.format(Locale.US, 
                          "TOTAL SUMMARY\n%.1f miles • %s\nIRS Deduction: $%.2f", 
                          totalMiles, formatDuration(totalDuration), deduction));
                      summaryText.setTextSize(16);
                      summaryText.setTextColor(Color.WHITE);
                      summaryText.setGravity(Gravity.CENTER);
                      summaryCard.addView(summaryText);
                      
                      tripsLayout.addView(summaryCard);
                      
                  } catch (JSONException e) {
                      Toast.makeText(this, "Error loading trips", Toast.LENGTH_SHORT).show();
                  }
              }
              
              private String formatDuration(long milliseconds) {
                  long seconds = milliseconds / 1000;
                  long minutes = seconds / 60;
                  long hours = minutes / 60;
                  
                  if (hours > 0) {
                      return String.format(Locale.US, "%d:%02d:%02d", hours, minutes % 60, seconds % 60);
                  } else {
                      return String.format(Locale.US, "%02d:%02d", minutes, seconds % 60);
                  }
              }
          }
          EOF

      - name: Create AndroidManifest.xml with background permissions
        run: |
          cat > android/app/src/main/AndroidManifest.xml << 'EOF'
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="com.miletrackerpro.app">
              
              <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
              <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
              <uses-permission android:name="android.permission.ACCESS_BACKGROUND_LOCATION" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
              <uses-permission android:name="android.permission.FOREGROUND_SERVICE_LOCATION" />
              <uses-permission android:name="android.permission.WAKE_LOCK" />
              <uses-permission android:name="android.permission.INTERNET" />
              
              <application
                  android:allowBackup="true"
                  android:label="@string/app_name"
                  android:theme="@android:style/Theme.Material.Light.NoActionBar">
                  
                  <activity
                      android:name=".MainActivity"
                      android:exported="true"
                      android:screenOrientation="portrait">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
                  
                  <service
                      android:name=".BackgroundGPSService"
                      android:enabled="true"
                      android:exported="false"
                      android:foregroundServiceType="location" />
                      
              </application>
          </manifest>
          EOF

      - name: Generate signing keystore
        run: |
          cd android
          keytool -genkey -v -keystore miletracker-release-key.keystore -alias miletracker -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=MileTracker Pro, OU=MileTracker, O=MileTracker, L=City, S=State, C=US"

      - name: Build signed APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew clean assembleRelease -Pandroid.injected.signing.store.file=$(pwd)/miletracker-release-key.keystore -Pandroid.injected.signing.store.password=android -Pandroid.injected.signing.key.alias=miletracker -Pandroid.injected.signing.key.password=android

      - name: Find and copy APK
        run: |
          find android -name "*.apk" -type f -exec cp {} ./miletracker-pro-background.apk \;
          ls -la *.apk

      - name: Upload Background Service APK
        uses: actions/upload-artifact@v4
        with:
          name: miletracker-pro-background-v6
          path: "*.apk"
          if-no-files-found: warn
