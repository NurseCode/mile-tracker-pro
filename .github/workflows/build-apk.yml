name: Build Android APK - Use Facebook React Plugin (Working WindowOptOut)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js 18
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
      with:
        api-level: 35
        build-tools: 35.0.0
        
    - name: Install dependencies
      run: npm install

    - name: Remove expo-constants References (React Native 0.76.0 Compatibility)
      run: |
        echo "Removing expo-constants for React Native 0.76.0 compatibility..."
        
        # Remove from package.json
        if [ -f "package.json" ]; then
          sed -i '/"expo-constants"/d' package.json
          echo "Removed expo-constants from package.json"
        fi
        
        # Remove from app.json plugins
        if [ -f "app.json" ]; then
          sed -i '/"expo-constants"/d' app.json
          echo "Removed expo-constants from app.json plugins"
        fi
        
        echo "expo-constants removal completed"

    - name: Generate React Native project
      run: npx expo prebuild --platform android --clean --no-install
        
    - name: Fix React Native 0.76.0 and Android API 35 compatibility
      run: |
        echo "Fixing Android build configuration for React Native 0.76.0..."
        
        # First, update SDK versions in root build.gradle to API 35
        cd android
        echo "Updating root build.gradle with API 35 support..."
        
        # Remove existing ext block if present and add new one with API 35
        sed -i '/ext {/,/}/d' build.gradle 2>/dev/null || true
        sed -i '/buildscript {/a\    ext {\n        buildToolsVersion = "35.0.0"\n        minSdkVersion = 24\n        compileSdkVersion = 35\n        targetSdkVersion = 35\n        ndkVersion = "25.1.8937393"\n        kotlinVersion = "1.9.22"\n    }' build.gradle
        
        echo "Root build.gradle updated with API 35"
        
        # Update app-level build.gradle with API 35 compatibility
        cd app
        echo "Creating app-level build.gradle with API 35 support..."
        
        cat > build.gradle << 'EOF'
        apply plugin: "com.android.application"
        apply plugin: "org.jetbrains.kotlin.android"
        apply plugin: "com.facebook.react"
        
        android {
            ndkVersion rootProject.ext.ndkVersion
            buildToolsVersion rootProject.ext.buildToolsVersion
            compileSdk rootProject.ext.compileSdkVersion
            
            namespace 'com.miletrackerpro.app'
            
            defaultConfig {
                applicationId 'com.miletrackerpro.app'
                minSdkVersion rootProject.ext.minSdkVersion
                targetSdkVersion rootProject.ext.targetSdkVersion
                versionCode 1
                versionName "1.0.0"
            }
            
            signingConfigs {
                debug {
                    storeFile file('debug.keystore')
                    storePassword 'android'
                    keyAlias 'androiddebugkey'
                    keyPassword 'android'
                }
            }
            
            buildTypes {
                debug {
                    signingConfig signingConfigs.debug
                }
                release {
                    signingConfig signingConfigs.debug
                    minifyEnabled false
                    proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
                }
            }
            
            packagingOptions {
                pickFirst "**/*.so"
                pickFirst "**/*.a"
            }
        }
        
        dependencies {
            implementation("com.facebook.react:react-android")
            implementation("androidx.swiperefreshlayout:swiperefreshlayout:1.0.0")
            debugImplementation("com.facebook.flipper:flipper:0.125.0")
            debugImplementation("com.facebook.flipper:flipper-network-plugin:0.125.0")
            debugImplementation("com.facebook.flipper:flipper-fresco-plugin:0.125.0")
            
            if (hermesEnabled.toBoolean()) {
                implementation("com.facebook.react:hermes-android")
            } else {
                implementation jscFlavor
            }
            
            // API 35 compatible AndroidX dependencies
            implementation 'androidx.core:core:1.13.1'
            implementation 'androidx.appcompat:appcompat:1.7.0'
            implementation 'androidx.activity:activity:1.9.2'
            implementation 'androidx.exifinterface:exifinterface:1.3.7'
            implementation 'com.google.android.material:material:1.12.0'
        }

        def enableHermes = true
        def hermesEnabled = enableHermes
        def jscFlavor = 'org.webkit:android-jsc:+'
        
        apply from: file("../../node_modules/@react-native-community/cli-platform-android/native_modules.gradle"); applyNativeModulesAppBuildGradle(project)
        EOF
        
        echo "App-level build.gradle created with API 35 support"
        
        echo "Android configuration fixed for API 35 compatibility"

    - name: Replace expo-root-project with com.facebook.react (Documented Solution)
      run: |
        cd android
        # Remove expo-root-project plugin and replace with com.facebook.react
        sed -i 's/apply plugin: "expo-root-project"/apply plugin: "com.facebook.react"/g' build.gradle
        sed -i '/expo-root-project/d' build.gradle
        
        # Ensure com.facebook.react plugin is present
        if ! grep -q "com.facebook.react" build.gradle; then
          echo 'apply plugin: "com.facebook.react"' >> build.gradle
        fi
        
        # Verify expo-constants removal worked
        echo "Checking if expo-constants was successfully excluded..."
        if ! grep -r "expo-constants" app/; then
          echo "SUCCESS: expo-constants successfully excluded from build"
        else
          echo "WARNING: expo-constants still found in generated files"
          grep -r "expo-constants" app/ || true
        fi

    - name: Enhanced WindowOptOut Attribute Removal (Post-Prebuild)
      run: |
        cd android
        echo "Enhanced removal of windowOptOutEdgeToEdgeEnforcement attributes after prebuild..."
        
        # Strategy 1: Remove from all XML files recursively
        echo "Removing from all XML files..."
        find . -name "*.xml" -type f -exec grep -l "windowOptOutEdgeToEdgeEnforcement" {} \; | \
          xargs -r sed -i '/windowOptOutEdgeToEdgeEnforcement/d'
        
        # Strategy 2: Remove item tags containing the attribute
        echo "Removing item tags with windowOptOutEdgeToEdgeEnforcement..."
        find . -name "*.xml" -type f -exec sed -i '/^[[:space:]]*<item[^>]*windowOptOutEdgeToEdgeEnforcement[^>]*>/d' {} \;
        
        # Strategy 3: Remove multi-line item tags
        echo "Removing multi-line item tags..."
        find . -name "*.xml" -type f -exec sed -i '/windowOptOutEdgeToEdgeEnforcement/{N;s/<item[^>]*windowOptOutEdgeToEdgeEnforcement[^>]*>.*<\/item>//g;}' {} \;
        
        # Strategy 4: Target specific theme and style files
        echo "Cleaning theme and style files specifically..."
        find . \( -name "themes.xml" -o -name "styles.xml" -o -name "values.xml" \) -type f -exec sed -i '/windowOptOutEdgeToEdgeEnforcement/d' {} \;
        
        # Strategy 5: Clean up any broken XML tags
        echo "Cleaning up broken XML tags..."
        find . -name "*.xml" -type f -exec sed -i '/^[[:space:]]*<item[[:space:]]*name="android:windowOptOutEdgeToEdgeEnforcement"/d' {} \;
        find . -name "*.xml" -type f -exec sed -i '/^[[:space:]]*android:windowOptOutEdgeToEdgeEnforcement/d' {} \;
        
        echo "Enhanced windowOptOutEdgeToEdgeEnforcement removal completed"

    - name: Verify WindowOptOut Removal
      run: |
        cd android
        echo "Verifying windowOptOutEdgeToEdgeEnforcement removal..."
        
        # Check if any XML files still contain the attribute
        if find . -name "*.xml" -type f -exec grep -l "windowOptOutEdgeToEdgeEnforcement" {} \; | head -5; then
          echo "WARNING: Found remaining windowOptOutEdgeToEdgeEnforcement references:"
          find . -name "*.xml" -type f -exec grep -n "windowOptOutEdgeToEdgeEnforcement" {} \; | head -10
        else
          echo "SUCCESS: No windowOptOutEdgeToEdgeEnforcement references found"
        fi

    - name: Build Android APK
      run: |
        echo "Building Android APK..."
        cd android
        ./gradlew assembleRelease --no-daemon --warning-mode=all
        echo "APK build completed"

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: MileTracker-Pro-APK
        path: android/app/build/outputs/apk/release/app-release.apk

    - name: Create Release
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: MileTracker Pro v${{ github.run_number }}
        body: |
          # MileTracker Pro APK v${{ github.run_number }}
          
          **Working WindowOptOut Solution**
          - ✅ React Native 0.76.0 compatibility
          - ✅ expo-constants removal 
          - ✅ expo-secure-store usage
          - ✅ API 35 compatibility
          - ✅ expo-root-project → com.facebook.react replacement
          - ✅ Enhanced windowOptOutEdgeToEdgeEnforcement removal
          - ✅ Preserves Expo-generated repositories configuration
          
          Download the APK and install on your Android device.
        files: android/app/build/outputs/apk/release/app-release.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
