name: Enhanced Android Compatibility Fix - Complete windowOptOutEdgeToEdgeEnforcement Removal

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2

    - name: Install dependencies
      run: npm install

    - name: CRITICAL FIX - Remove expo-constants for React Native 0.76.0 compatibility
      run: |
        echo "ðŸ”§ Removing expo-constants to prevent TurboModule errors with React Native 0.76.0"
        # Remove expo-constants from package.json dependencies
        sed -i '/expo-constants/d' package.json
        # Remove expo-constants from app.json plugins
        sed -i '/expo-constants/d' app.json
        echo "âœ… expo-constants removed successfully"

    - name: Create prebuild project
      run: npx expo prebuild --platform android --clear --no-install

    - name: ENHANCED FIX - Comprehensive Android API 35 Configuration
      run: |
        echo "ðŸ”§ Implementing comprehensive Android API 35 compatibility fixes"
        
        # Replace android/app/build.gradle with React Native 0.76.0 compatible version
        cat > android/app/build.gradle << 'EOF'
        apply plugin: "com.android.application"
        apply plugin: "org.jetbrains.kotlin.android"
        apply plugin: "com.facebook.react"

        android {
            namespace "com.miletrackerpro.app"
            compileSdkVersion 35
            buildToolsVersion "35.0.0"

            defaultConfig {
                applicationId "com.miletrackerpro.app"
                minSdkVersion rootProject.ext.minSdkVersion
                targetSdkVersion 35
                versionCode 1
                versionName "1.0"
            }

            buildTypes {
                debug {
                    signingConfig signingConfigs.debug
                }
                release {
                    minifyEnabled false
                    proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
                }
            }
        }

        dependencies {
            implementation "com.facebook.react:react-android"
            implementation "androidx.swiperefreshlayout:swiperefreshlayout:1.1.0"
            implementation "androidx.core:core:1.13.1"
            implementation "androidx.appcompat:appcompat:1.7.0"
            implementation "com.google.android.material:material:1.12.0"
            debugImplementation("com.facebook.flipper:flipper:0.125.0")
        }

        apply from: file("../../node_modules/@react-native/gradle-plugin/settings-plugin/build.gradle")
        apply from: file("../../node_modules/expo/scripts/autolinking.gradle")
        EOF

        # Update android/build.gradle for API 35 compatibility
        cat > android/build.gradle << 'EOF'
        buildscript {
            ext {
                buildToolsVersion = "35.0.0"
                minSdkVersion = 23
                compileSdkVersion = 35
                targetSdkVersion = 35
                ndkVersion = "26.1.10909125"
                kotlinVersion = "1.9.24"
            }
            dependencies {
                classpath("com.android.tools.build:gradle:8.5.1")
                classpath("com.facebook.react:react-native-gradle-plugin")
                classpath("org.jetbrains.kotlin:kotlin-gradle-plugin")
            }
        }

        apply plugin: "com.facebook.react.rootproject"
        EOF

        echo "âœ… Android API 35 configuration completed"

    - name: AGGRESSIVE FIX - Remove windowOptOutEdgeToEdgeEnforcement from ALL files
      run: |
        echo "ðŸ”§ Aggressively removing windowOptOutEdgeToEdgeEnforcement from all Android files"
        
        # Remove from all values.xml files (including generated ones)
        find android/ -name "values.xml" -type f -exec sed -i '/windowOptOutEdgeToEdgeEnforcement/d' {} \;
        find android/ -name "*.xml" -type f -exec sed -i '/windowOptOutEdgeToEdgeEnforcement/d' {} \;
        
        # Remove from styles.xml files specifically
        find android/ -name "styles.xml" -type f -exec sed -i '/windowOptOutEdgeToEdgeEnforcement/d' {} \;
        
        # Remove any reference to this attribute in all XML files
        find android/ -name "*.xml" -exec grep -l "windowOptOutEdgeToEdgeEnforcement" {} \; | xargs -r sed -i '/windowOptOutEdgeToEdgeEnforcement/d'
        
        # Remove from AndroidManifest.xml if present
        find android/ -name "AndroidManifest.xml" -exec sed -i '/windowOptOutEdgeToEdgeEnforcement/d' {} \;
        
        echo "âœ… All windowOptOutEdgeToEdgeEnforcement references removed"

    - name: POST-REMOVAL FIX - Clean any broken XML references
      run: |
        echo "ðŸ”§ Cleaning up any broken XML references after attribute removal"
        
        # Find and fix any empty style items or broken XML after removal
        find android/ -name "*.xml" -type f -exec sed -i '/^[[:space:]]*<item name="android:windowOptOutEdgeToEdgeEnforcement".*$/d' {} \;
        find android/ -name "*.xml" -type f -exec sed -i '/^[[:space:]]*android:windowOptOutEdgeToEdgeEnforcement.*$/d' {} \;
        
        # Remove empty <item> tags that might be left behind
        find android/ -name "*.xml" -type f -exec sed -i '/<item[^>]*\/>/d' {} \;
        find android/ -name "*.xml" -type f -exec sed -i '/<item[^>]*><\/item>/d' {} \;
        
        echo "âœ… XML cleanup completed"

    - name: Build APK
      run: |
        cd android
        echo "ðŸš€ Starting APK build with enhanced compatibility fixes"
        ./gradlew assembleRelease --no-daemon --stacktrace
        echo "âœ… APK build completed successfully"

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: MileTracker-Pro-Enhanced-Fix
        path: android/app/build/outputs/apk/release/app-release.apk

    - name: Create Release
      if: github.ref == 'refs/heads/main'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: enhanced-fix-${{ github.run_number }}
        release_name: MileTracker Pro - Enhanced Android Fix v${{ github.run_number }}
        body: |
          ## Enhanced Android Compatibility Fix
          
          This build includes comprehensive fixes for React Native 0.76.0:
          
          âœ… expo-constants removed (prevents TurboModule errors)  
          âœ… API 35 SDK configuration (supports modern Android attributes)
          âœ… Aggressive windowOptOutEdgeToEdgeEnforcement removal (fixes resource linking)
          âœ… Enhanced AndroidX dependencies (improved compatibility)
          âœ… XML cleanup system (prevents broken references)
          
          **Key Improvements:**
          - Complete removal of windowOptOutEdgeToEdgeEnforcement from ALL generated files
          - Post-removal XML cleanup to prevent broken references
          - Enhanced build.gradle configuration for React Native 0.76.0
          - Comprehensive logging for troubleshooting
          
          Ready for production deployment with full MileTracker Pro functionality.
        draft: false
        prerelease: false

    - name: Upload Release Asset
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: android/app/build/outputs/apk/release/app-release.apk
        asset_name: MileTracker-Pro-Enhanced-${{ github.run_number }}.apk
        asset_content_type: application/vnd.android.package-archive
