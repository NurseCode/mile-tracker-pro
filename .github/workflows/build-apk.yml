name: Phase 3 - MileTracker Pro Features

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Clean and create Android project structure
        run: |
          rm -rf android
          mkdir -p android/app/src/main/java/com/miletrackerpro/app
          mkdir -p android/app/src/main/res/layout
          mkdir -p android/app/src/main/res/values
          mkdir -p android/gradle/wrapper

      - name: Create Gradle wrapper
        run: |
          cat > android/gradle/wrapper/gradle-wrapper.properties << 'EOF'
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.6-all.zip
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          EOF

      - name: Create Gradle wrapper JAR
        run: |
          mkdir -p android/gradle/wrapper
          curl -L https://github.com/gradle/gradle/raw/v8.6.0/gradle/wrapper/gradle-wrapper.jar -o android/gradle/wrapper/gradle-wrapper.jar

      - name: Create gradlew script
        run: |
          cat > android/gradlew << 'EOF'
          #!/usr/bin/env sh
          APP_HOME="`dirname \"$0\"`"
          CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar
          if [ -n "$JAVA_HOME" ] ; then
              JAVACMD="$JAVA_HOME/bin/java"
          else
              JAVACMD="java"
          fi
          exec "$JAVACMD" -classpath "$CLASSPATH" org.gradle.wrapper.GradleWrapperMain "$@"
          EOF
          chmod +x android/gradlew

      - name: Create settings.gradle
        run: |
          cat > android/settings.gradle << 'EOF'
          rootProject.name = 'MileTrackerPro'
          include ':app'
          EOF

      - name: Create build.gradle
        run: |
          cat > android/build.gradle << 'EOF'
          buildscript {
              ext {
                  buildToolsVersion = "34.0.0"
                  minSdkVersion = 21
                  compileSdkVersion = 34
                  targetSdkVersion = 34
              }
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath("com.android.tools.build:gradle:8.2.1")
              }
          }
          
          allprojects {
              repositories {
                  google()
                  mavenCentral()
              }
          }
          EOF

      - name: Create app/build.gradle with GPS permissions
        run: |
          cat > android/app/build.gradle << 'EOF'
          apply plugin: "com.android.application"
          
          android {
              namespace "com.miletrackerpro.app"
              compileSdkVersion 34
              
              defaultConfig {
                  applicationId "com.miletrackerpro.app"
                  minSdkVersion 21
                  targetSdkVersion 34
                  versionCode 3
                  versionName "3.0"
              }
              
              buildTypes {
                  release {
                      minifyEnabled false
                  }
              }
              
              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_1_8
                  targetCompatibility JavaVersion.VERSION_1_8
              }
          }
          
          dependencies {
              // Pure Android - no external dependencies
          }
          EOF

      - name: Create strings.xml
        run: |
          cat > android/app/src/main/res/values/strings.xml << 'EOF'
          <resources>
              <string name="app_name">MileTracker Pro</string>
              <string name="start_trip">START TRIP</string>
              <string name="stop_trip">STOP TRIP</string>
              <string name="location_permission">This app needs location permission to track mileage</string>
          </resources>
          EOF

      - name: Create MainActivity with GPS tracking
        run: |
          cat > android/app/src/main/java/com/miletrackerpro/app/MainActivity.java << 'EOF'
          package com.miletrackerpro.app;
          
          import android.app.Activity;
          import android.os.Bundle;
          import android.widget.LinearLayout;
          import android.widget.TextView;
          import android.widget.Button;
          import android.graphics.Color;
          import android.view.Gravity;
          import android.view.ViewGroup;
          import android.widget.Toast;
          import android.content.Context;
          import android.location.LocationManager;
          import android.location.LocationListener;
          import android.location.Location;
          import android.Manifest;
          import android.content.pm.PackageManager;
          import android.os.Build;
          import java.text.SimpleDateFormat;
          import java.util.Date;
          import java.util.Locale;
          
          public class MainActivity extends Activity implements LocationListener {
              
              private LocationManager locationManager;
              private boolean isTracking = false;
              private Location startLocation;
              private Location lastLocation;
              private long tripStartTime;
              private float totalDistance = 0;
              
              private TextView statusText;
              private TextView distanceText;
              private TextView timeText;
              private Button actionButton;
              
              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  
                  locationManager = (LocationManager) getSystemService(Context.LOCATION_SERVICE);
                  
                  createUserInterface();
                  checkLocationPermission();
              }
              
              private void createUserInterface() {
                  // Main container
                  LinearLayout mainLayout = new LinearLayout(this);
                  mainLayout.setOrientation(LinearLayout.VERTICAL);
                  mainLayout.setBackgroundColor(Color.parseColor("#667eea"));
                  mainLayout.setPadding(40, 60, 40, 40);
                  
                  // Title
                  TextView title = new TextView(this);
                  title.setText("MileTracker Pro");
                  title.setTextSize(32);
                  title.setTextColor(Color.WHITE);
                  title.setGravity(Gravity.CENTER);
                  title.setPadding(0, 0, 0, 40);
                  mainLayout.addView(title);
                  
                  // Status card
                  LinearLayout statusCard = new LinearLayout(this);
                  statusCard.setOrientation(LinearLayout.VERTICAL);
                  statusCard.setBackgroundColor(Color.parseColor("#ffffff"));
                  statusCard.setPadding(30, 30, 30, 30);
                  statusCard.setLayoutParams(new LinearLayout.LayoutParams(
                      ViewGroup.LayoutParams.MATCH_PARENT, 
                      ViewGroup.LayoutParams.WRAP_CONTENT));
                  
                  // Status text
                  statusText = new TextView(this);
                  statusText.setText("Ready to Track");
                  statusText.setTextSize(24);
                  statusText.setTextColor(Color.parseColor("#333333"));
                  statusText.setGravity(Gravity.CENTER);
                  statusText.setPadding(0, 0, 0, 20);
                  statusCard.addView(statusText);
                  
                  // Distance display
                  distanceText = new TextView(this);
                  distanceText.setText("Distance: 0.0 miles");
                  distanceText.setTextSize(18);
                  distanceText.setTextColor(Color.parseColor("#666666"));
                  distanceText.setGravity(Gravity.CENTER);
                  statusCard.addView(distanceText);
                  
                  // Time display
                  timeText = new TextView(this);
                  timeText.setText("Duration: 00:00");
                  timeText.setTextSize(18);
                  timeText.setTextColor(Color.parseColor("#666666"));
                  timeText.setGravity(Gravity.CENTER);
                  timeText.setPadding(0, 10, 0, 0);
                  statusCard.addView(timeText);
                  
                  mainLayout.addView(statusCard);
                  
                  // Action button
                  actionButton = new Button(this);
                  actionButton.setText("START TRIP");
                  actionButton.setTextSize(20);
                  actionButton.setTextColor(Color.WHITE);
                  actionButton.setBackgroundColor(Color.parseColor("#10b981"));
                  actionButton.setPadding(40, 30, 40, 30);
                  LinearLayout.LayoutParams buttonParams = new LinearLayout.LayoutParams(
                      ViewGroup.LayoutParams.MATCH_PARENT, 
                      ViewGroup.LayoutParams.WRAP_CONTENT);
                  buttonParams.setMargins(0, 40, 0, 0);
                  actionButton.setLayoutParams(buttonParams);
                  
                  actionButton.setOnClickListener(v -> {
                      if (isTracking) {
                          stopTrip();
                      } else {
                          startTrip();
                      }
                  });
                  
                  mainLayout.addView(actionButton);
                  
                  // Feature list
                  TextView features = new TextView(this);
                  features.setText("✓ Real-time GPS tracking\n✓ Automatic distance calculation\n✓ Professional mileage logging");
                  features.setTextSize(14);
                  features.setTextColor(Color.parseColor("#c7d2fe"));
                  features.setGravity(Gravity.CENTER);
                  features.setLineSpacing(8, 1.2f);
                  features.setPadding(0, 40, 0, 0);
                  mainLayout.addView(features);
                  
                  setContentView(mainLayout);
              }
              
              private void checkLocationPermission() {
                  if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
                      if (checkSelfPermission(Manifest.permission.ACCESS_FINE_LOCATION) != PackageManager.PERMISSION_GRANTED) {
                          requestPermissions(new String[]{Manifest.permission.ACCESS_FINE_LOCATION}, 1);
                          return;
                      }
                  }
                  initializeLocationTracking();
              }
              
              @Override
              public void onRequestPermissionsResult(int requestCode, String[] permissions, int[] grantResults) {
                  if (requestCode == 1) {
                      if (grantResults.length > 0 && grantResults[0] == PackageManager.PERMISSION_GRANTED) {
                          initializeLocationTracking();
                      } else {
                          Toast.makeText(this, "Location permission required for GPS tracking", Toast.LENGTH_LONG).show();
                      }
                  }
              }
              
              private void initializeLocationTracking() {
                  statusText.setText("GPS Ready - Tap to Start");
              }
              
              private void startTrip() {
                  try {
                      if (checkSelfPermission(Manifest.permission.ACCESS_FINE_LOCATION) == PackageManager.PERMISSION_GRANTED) {
                          locationManager.requestLocationUpdates(LocationManager.GPS_PROVIDER, 2000, 5, this);
                          locationManager.requestLocationUpdates(LocationManager.NETWORK_PROVIDER, 2000, 5, this);
                          
                          isTracking = true;
                          tripStartTime = System.currentTimeMillis();
                          totalDistance = 0;
                          
                          statusText.setText("Tracking Active");
                          actionButton.setText("STOP TRIP");
                          actionButton.setBackgroundColor(Color.parseColor("#ef4444"));
                          
                          updateTimer();
                          
                          Toast.makeText(this, "Trip started - GPS tracking active", Toast.LENGTH_SHORT).show();
                      }
                  } catch (SecurityException e) {
                      Toast.makeText(this, "Location permission required", Toast.LENGTH_SHORT).show();
                  }
              }
              
              private void stopTrip() {
                  locationManager.removeUpdates(this);
                  isTracking = false;
                  
                  statusText.setText("Trip Completed");
                  actionButton.setText("START TRIP");
                  actionButton.setBackgroundColor(Color.parseColor("#10b981"));
                  
                  // Show trip summary
                  String summary = String.format(Locale.US, 
                      "Trip completed!\nDistance: %.2f miles\nDuration: %s", 
                      totalDistance, formatDuration(System.currentTimeMillis() - tripStartTime));
                  
                  Toast.makeText(this, summary, Toast.LENGTH_LONG).show();
                  
                  // Reset for next trip
                  startLocation = null;
                  lastLocation = null;
              }
              
              private void updateTimer() {
                  if (isTracking) {
                      long duration = System.currentTimeMillis() - tripStartTime;
                      timeText.setText("Duration: " + formatDuration(duration));
                      
                      // Update every second
                      timeText.postDelayed(this::updateTimer, 1000);
                  }
              }
              
              private String formatDuration(long milliseconds) {
                  long seconds = milliseconds / 1000;
                  long minutes = seconds / 60;
                  long hours = minutes / 60;
                  
                  if (hours > 0) {
                      return String.format(Locale.US, "%d:%02d:%02d", hours, minutes % 60, seconds % 60);
                  } else {
                      return String.format(Locale.US, "%02d:%02d", minutes, seconds % 60);
                  }
              }
              
              @Override
              public void onLocationChanged(Location location) {
                  if (!isTracking) return;
                  
                  if (startLocation == null) {
                      startLocation = location;
                      lastLocation = location;
                      return;
                  }
                  
                  if (lastLocation != null) {
                      float distance = lastLocation.distanceTo(location);
                      totalDistance += distance * 0.000621371f; // Convert meters to miles
                      
                      distanceText.setText(String.format(Locale.US, "Distance: %.2f miles", totalDistance));
                  }
                  
                  lastLocation = location;
              }
              
              @Override
              public void onStatusChanged(String provider, int status, Bundle extras) {}
              
              @Override
              public void onProviderEnabled(String provider) {}
              
              @Override
              public void onProviderDisabled(String provider) {}
          }
          EOF

      - name: Create AndroidManifest.xml with GPS permissions
        run: |
          cat > android/app/src/main/AndroidManifest.xml << 'EOF'
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="com.miletrackerpro.app">
              
              <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
              <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
              <uses-permission android:name="android.permission.INTERNET" />
              
              <application
                  android:allowBackup="true"
                  android:label="@string/app_name"
                  android:theme="@android:style/Theme.Material.Light.NoActionBar">
                  <activity
                      android:name=".MainActivity"
                      android:exported="true"
                      android:screenOrientation="portrait">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

      - name: Generate signing keystore
        run: |
          cd android
          keytool -genkey -v -keystore miletracker-release-key.keystore -alias miletracker -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=MileTracker Pro, OU=MileTracker, O=MileTracker, L=City, S=State, C=US"

      - name: Build signed APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew clean assembleRelease -Pandroid.injected.signing.store.file=$(pwd)/miletracker-release-key.keystore -Pandroid.injected.signing.store.password=android -Pandroid.injected.signing.key.alias=miletracker -Pandroid.injected.signing.key.password=android

      - name: Find and copy APK
        run: |
          find android -name "*.apk" -type f -exec cp {} ./miletracker-pro-phase3.apk \;
          ls -la *.apk

      - name: Upload Phase 3 APK
        uses: actions/upload-artifact@v4
        with:
          name: miletracker-pro-phase3-gps
          path: "*.apk"
          if-no-files-found: warn
