name: Build Android APK - Use Facebook React Plugin (Documented Working Solution)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
      
    - name: Accept Android SDK licenses
      run: |
        yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses || true
        
    - name: Install Android SDK components
      run: |
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager \
          "platform-tools" \
          "platforms;android-34" \
          "build-tools;34.0.0" \
          "ndk;26.1.10909125"

    - name: Set environment variables
      run: |
        echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/26.1.10909125" >> $GITHUB_ENV
        echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/26.1.10909125" >> $GITHUB_ENV

    - name: Install dependencies
      run: npm install

    - name: Setup Expo CLI
      run: npm install -g @expo/cli

    - name: Use corrected package.json and create expo-constants override
      run: |
        # Create corrected package.json that overrides expo-constants
        cat > package.json << 'EOF'
        {
          "name": "miletracker-pro",
          "version": "1.0.0",
          "main": "index.js",
          "scripts": {
            "start": "expo start",
            "android": "expo start --android",
            "ios": "expo start --ios",
            "web": "expo start --web"
          },
          "dependencies": {
            "expo": "53.0.13",
            "expo-status-bar": "~2.2.3",
            "react": "18.2.0",
            "react-native": "0.76.0",
            "expo-secure-store": "~14.0.0",
            "expo-camera": "~16.0.0",
            "expo-file-system": "~18.0.0",
            "expo-sharing": "~13.0.0",
            "expo-mail-composer": "~14.0.0"
          },
          "devDependencies": {
            "@babel/core": "^7.20.0",
            "@react-native-community/cli": "15.1.0",
            "@react-native-community/cli-platform-android": "15.1.0"
          },
          "overrides": {
            "expo-constants": "file:./no-expo-constants"
          },
          "private": true
        }
        EOF
        
        # Create dummy expo-constants override to prevent React Native 0.76.0 incompatibility
        mkdir -p no-expo-constants
        cat > no-expo-constants/package.json << 'EOF'
        {
          "name": "expo-constants",
          "version": "17.1.6",
          "main": "index.js"
        }
        EOF
        
        cat > no-expo-constants/index.js << 'EOF'
        // Dummy expo-constants replacement for React Native 0.76.0 compatibility
        export default {
          executionEnvironment: 'standalone',
          platform: {
            OS: 'android'
          },
          manifest: {},
          expoVersion: '53.0.13'
        };
        EOF
        
        echo "Created expo-constants override to prevent React Native 0.76.0 compatibility issues"
        
    - name: Generate native project without expo-constants
      run: npx expo prebuild --platform android --clean --no-install
        
    - name: Replace expo-root-project with com.facebook.react (Documented Solution)
      run: |
        cd android
        # Remove expo-root-project plugin and replace with com.facebook.react
        sed -i 's/apply plugin: "expo-root-project"/apply plugin: "com.facebook.react"/g' build.gradle
        sed -i '/expo-root-project/d' build.gradle
        
        # Ensure com.facebook.react plugin is present
        if ! grep -q "com.facebook.react" build.gradle; then
          echo 'apply plugin: "com.facebook.react"' >> build.gradle
        fi
        
        # Verify expo-constants removal worked
        echo "Checking if expo-constants was successfully excluded..."
        if [ -d "node_modules/expo-constants" ]; then
          echo "WARNING: expo-constants still present, manually removing..."
          rm -rf node_modules/expo-constants
        fi
        
        # Add required ext properties for React Native 0.76.0
        cat >> build.gradle << 'EOF'

        allprojects {
            repositories {
                google()
                mavenCentral()
                maven { url "https://www.jitpack.io" }
            }
        }

        // React Native 0.76.0 compatibility
        ext {
            buildToolsVersion = "34.0.0"
            minSdkVersion = 24
            compileSdkVersion = 34
            targetSdkVersion = 34
            ndkVersion = "26.1.10909125"
            kotlinVersion = "1.9.22"
        }
        EOF

    - name: Use working android/app/build.gradle for React Native 0.76.0
      run: |
        cd android/app
        cat > build.gradle << 'EOF'
        apply plugin: "com.android.application"
        apply plugin: "org.jetbrains.kotlin.android"
        apply plugin: "com.facebook.react"

        android {
            ndkVersion "26.1.10909125"
            compileSdkVersion 34

            namespace 'com.miletrackerpro.app'
            defaultConfig {
                applicationId 'com.miletrackerpro.app'
                minSdkVersion 24
                targetSdkVersion 34
                versionCode 1
                versionName "1.0.0"
                multiDexEnabled true
            }
            
            signingConfigs {
                debug {
                    storeFile file('debug.keystore')
                    storePassword 'android'
                    keyAlias 'androiddebugkey'
                    keyPassword 'android'
                }
            }
            
            buildTypes {
                debug {
                    signingConfig signingConfigs.debug
                }
                release {
                    signingConfig signingConfigs.debug
                    minifyEnabled false
                }
            }
        }

        dependencies {
            implementation("com.facebook.react:react-android:0.76.0")
            implementation("com.facebook.react:hermes-android:0.76.0")
            
            // AndroidX dependencies for background GPS service (from documented solution)
            implementation 'androidx.core:core:1.9.0'
            implementation 'androidx.appcompat:appcompat:1.5.1'
            implementation 'com.google.android.gms:play-services-location:21.0.1'
        }
        EOF

    - name: Build Android APK
      run: |
        cd android
        chmod +x gradlew
        ./gradlew assembleRelease --stacktrace

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: miletracker-pro-release.apk
        path: android/app/build/outputs/apk/release/app-release.apk
