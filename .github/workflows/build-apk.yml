name: Final Compilation Fix - v4.9.65

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Create simple working delete functionality
        run: |
          # Fix the delete functionality to use only what actually exists in MainActivity
          # Based on error analysis:
          # - MainActivity has NO cloudBackupService field
          # - MainActivity has NO displayTrips() or updateDashboardStats() methods
          # - MainActivity DOES have updateRecentTrips(), updateAllTrips(), updateStats()
          # - TripStorage DOES have deleteTrip(long tripId) method that handles everything
          
          # Create the minimal fix that just works
          cat > MainActivity_delete_fix.java << 'PATCH'
                  builder.setPositiveButton("üóëÔ∏è DELETE PERMANENTLY", (dialog, which) -> {
                      try {
                          // Use TripStorage's built-in delete method - it handles everything internally
                          tripStorage.deleteTrip(trip.getId());
                          
                          // Refresh the UI using the methods that actually exist
                          updateRecentTrips();
                          updateAllTrips();
                          updateStats();
                          
                          Toast.makeText(this, "üóëÔ∏è Trip deleted successfully", Toast.LENGTH_SHORT).show();
                      } catch (Exception e) {
                          Log.e(TAG, "Error deleting trip: " + e.getMessage(), e);
                          Toast.makeText(this, "‚ùå Error deleting trip", Toast.LENGTH_SHORT).show();
                      }
                  });
          PATCH

      - name: Apply the simple delete fix to MainActivity
        run: |
          # Find and replace the problematic delete code with the working version
          if [ -f "android/app/src/main/java/com/miletrackerpro/app/MainActivity.java" ]; then
            # Replace the broken delete code with the simple working version
            sed -i '/List<Trip> trips = tripStorage\.getTrips();/,/updateDashboardStats();/{
              /List<Trip> trips = tripStorage\.getTrips();/d
              /trips\.remove(trip);/d
              /tripStorage\.saveTripsToStorage(trips);/d
              /cloudBackupService\.saveTrip(trip, true);/d
              /displayTrips();/d
              /updateDashboardStats();/d
              /try {/a\
                          // Use TripStorage'\''s built-in delete method - it handles everything internally\
                          tripStorage.deleteTrip(trip.getId());\
                          \
                          // Refresh the UI using the methods that actually exist\
                          updateRecentTrips();\
                          updateAllTrips();\
                          updateStats();
            }' android/app/src/main/java/com/miletrackerpro/app/MainActivity.java
            
            echo "‚úÖ Applied simple delete fix to MainActivity"
          else
            echo "‚ùå MainActivity not found"
            exit 1
          fi

      - name: Verify the fix worked
        run: |
          if grep -q "tripStorage.deleteTrip" android/app/src/main/java/com/miletrackerpro/app/MainActivity.java; then
            echo "‚úÖ Delete fix applied successfully"
          else
            echo "‚ùå Delete fix failed to apply"
            exit 1
          fi

      - name: Build APK
        run: |
          cd android
          ./gradlew assembleRelease --no-daemon

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: MileTracker-Pro-v4.9.65-Final-Compilation-Fix
          path: android/app/build/outputs/apk/release/*.apk
